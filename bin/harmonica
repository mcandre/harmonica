#!/bin/sh
unset IFS
set -euf

HARMONICA_VERSION='0.0.2'
PREFIX='issue-'
BATCH_CAPACITY='0'
PRE_PROCESS_ZIP='0'
ASSETS=''
POST_PROCESS_CBZ='0'
LF='
'

usage() {
    echo "Usage: $0 [OPTIONS] <source directory>"
    echo ''
    echo "-p <prefix>\tcustomize target prefix (default: \"[../]${PREFIX}\")"
    echo "-n <limit>\tapply uniform directory size (default: source entries / 2)"
    echo "-u\t\tpre-process expand cbz/zip archive (default: false)"
    echo "-b <assets>\tcopy boilerplate assets (comma separated) to each batch (default: '')"
    echo "-z\t\tpost-process cbz archival (default: false)"
    echo "-v\t\tshow version"
    echo "-h\t\tshow usage menu"
}

ARGS="$*"

for ARG in $ARGS; do
    case "$ARG" in
    -p)
        shift

        if [ "$#" -lt 1 ]; then
            usage
            exit 1
        fi

        PREFIX="$1"
        shift
        ;;
    -n)
        shift

        if [ "$#" -lt 1 ]; then
            usage
            exit 1
        fi

        BATCH_CAPACITY="$1"
        shift
        ;;
    -u)
        PRE_PROCESS_ZIP='1'
        shift
        ;;
    -b)
        shift

        if [ "$#" -lt 1 ]; then
            usage
            exit 1
        fi

        ASSETS="$1"
        shift
        ;;
    -z)
        POST_PROCESS_CBZ='1'
        shift
        ;;
    -v)
        echo "$HARMONICA_VERSION"
        exit
        ;;
    -h)
        usage
        exit
        ;;
    -*)
        usage
        exit 1
    esac
done

if [ "$#" -ne 1 ]; then
    usage
    exit 1
fi

SOURCE="$1"

if [ "$SOURCE" = '.' ]; then
    PREFIX="../${PREFIX}"
fi

if [ "$PRE_PROCESS_ZIP" = '1' ]; then
    unzip -u "$SOURCE"
    SOURCE="$(basename -s '.cbz' "$SOURCE")"
    SOURCE="$(basename -s '.zip' "$SOURCE")"
fi

find_source() {
    find "$SOURCE" \
        -name '.DS_Store' -o -name 'Thumbs.db' -prune -o \
        -type f \
        -print
}

if [ "$BATCH_CAPACITY" -le '0' ]; then
    SOURCE_DIRECTORY_ENTRIES="$(find_source | wc -l)"
    BATCH_CAPACITY=$((SOURCE_DIRECTORY_ENTRIES / 2))
fi

I=1

# shellcheck disable=SC3045
find_source |
    sort |
    xargs -n "$BATCH_CAPACITY" |
    while IFS= read -r "-d${LF}" FS; do
        TARGET="${PREFIX}${I}"
        mkdir -p "$TARGET"

        for F in $FS; do
            cp "$F" "$TARGET"
        done

        echo "${ASSETS}," |
        while IFS= read -r '-d,' ASSET; do
            cp "$ASSET" "$TARGET"
        done

        if [ "$POST_PROCESS_CBZ" -eq '1' ]; then
            zip -r "${TARGET}.cbz" "$TARGET"
        fi

        I=$((I + 1))
    done
