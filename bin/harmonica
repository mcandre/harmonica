#!/bin/sh
unset IFS
set -euf

HARMONICA_VERSION='0.0.1'
PREFIX='issue-'
BATCH_CAPACITY='0'
LF='
'

usage() {
    echo "Usage: $0 [OPTIONS] <source directory>"
    echo ''
    echo "-p\t<destination directory prefix>\tDefault: \"$PREFIX\""
    echo "-n\t<batch directory capacity>\tDefault: (source directory entries)/2"
    echo "-v\t\t\t\t\tShow version"
    echo "-h\t\t\t\t\tShow usage menu"
}

ARGS="$*"

for ARG in $ARGS; do
    case "$ARG" in
    -p)
        shift

        if [ "$#" -lt 1 ]; then
            usage
            exit 1
        fi

        PREFIX="$1"
        shift
        ;;
    -n)
        shift

        if [ "$#" -lt 1 ]; then
            usage
            exit 1
        fi

        BATCH_CAPACITY="$1"
        shift
        ;;
    -h)
        usage
        exit
        ;;
    -v)
        echo "$HARMONICA_VERSION"
        exit
        ;;
    -*)
        usage
        exit 1
    esac
done

if [ "$#" -ne 1 ]; then
    usage
    exit 1
fi

SOURCE="$1"

find_source() {
    find "$SOURCE" \
        -name '.DS_Store' -o -name 'Thumbs.db' -prune -o \
        -type f \
        -print
}

if [ "$BATCH_CAPACITY" -le '0' ]; then
    SOURCE_DIRECTORY_ENTRIES="$(find_source | wc -l)"
    BATCH_CAPACITY=$((SOURCE_DIRECTORY_ENTRIES / 2))
fi

I=1

# shellcheck disable=SC3045
find_source |
    sort |
    xargs -n "$BATCH_CAPACITY" |
    while IFS= read -r "-d${LF}" fs; do
        TARGET="${PREFIX}${I}"
        mkdir -p "$TARGET"

        for f in $fs; do
            cp "$f" "$TARGET"
        done

        I=$((I + 1))
    done
